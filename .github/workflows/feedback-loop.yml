name: ğŸ”„ Feedback Loop

# The full autonomous cycle:
#   1. signal_tracker  â€” what worked yesterday
#   2. loop_brain      â€” decide what to do today (Ollama locally / rules in cloud)
#   3. humanitarian_content â€” generate + post weighted toward what works
#
# Runs daily at 6am UTC (1 hour after knowledge harvest).
# Can also be triggered manually.

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  loop:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: pip install requests

      - name: "Step 1 â€” Signal Tracker: what worked"
        env:
          GITHUB_TOKEN:       ${{ secrets.GITHUB_TOKEN }}
          MASTODON_TOKEN:     ${{ secrets.MASTODON_TOKEN }}
          MASTODON_SERVER:    ${{ secrets.MASTODON_URL }}
          GUMROAD_TOKEN:      ${{ secrets.GUMROAD_TOKEN }}
        run: |
          mkdir -p data
          python mycelium/signal_tracker.py || echo "Signal tracker error â€” continuing"

      - name: "Step 2 â€” Loop Brain: build strategy"
        run: python mycelium/loop_brain.py

      - name: "Step 3 â€” Humanitarian Content: generate + post"
        env:
          MASTODON_TOKEN:        ${{ secrets.MASTODON_TOKEN }}
          MASTODON_URL:          ${{ secrets.MASTODON_URL }}
          BLUESKY_HANDLE:        ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD:  ${{ secrets.BLUESKY_APP_PASSWORD }}
        run: python mycelium/humanitarian_content.py

      - name: Commit all outputs
        run: |
          git config user.name  "meeko-loop"
          git config user.email "loop@meeko-nerve-center"
          git add data/ content/
          git diff --cached --quiet && echo "No changes" || (
            git commit -m "ğŸ”„ feedback loop [$(date -u +%Y-%m-%d)]" && git push
          )

      - name: Print strategy summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo " TODAY'S LOOP COMPLETE"
          cat data/strategy.json 2>/dev/null | python3 -c "
import json,sys
d=json.load(sys.stdin)
print(f\" Crisis: {d.get('primary_crisis','?')}\")
print(f\" Channel: {d.get('push_channel','?')}\")
print(f\" Method: {d.get('method','?')}\")
print(f\" Reasoning: {d.get('reasoning','?')[:100]}\")
" || echo "(strategy.json not found)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
