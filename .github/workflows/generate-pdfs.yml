name: Generate Product PDFs

on:
  push:
    paths:
      - 'products/0*.md'
  workflow_dispatch:

jobs:
  build-pdfs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install pandoc
        run: sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended
      
      - name: Generate PDFs
        run: |
          mkdir -p products/pdf
          for f in products/[0-9]*.md; do
            name=$(basename "$f" .md)
            echo "Generating: $name"
            pandoc "$f" \
              -o "products/pdf/${name}.pdf" \
              -V geometry:margin=1in \
              -V fontsize=11pt \
              -V colorlinks=true \
              2>/dev/null && echo "  OK" || echo "  WARN: failed for $name"
          done
          ls -lh products/pdf/
      
      - name: Commit PDFs
        run: |
          git config user.name "meeko-pdf-engine"
          git config user.email "pdf@meeko-nerve-center"
          git add products/pdf/
          git diff --staged --quiet || git commit -m "auto: product PDFs [$(date -u +%Y-%m-%dT%H:%M)]"
          git push
      
      - name: Post to Gumroad (when token available)
        if: env.GUMROAD_TOKEN != ''
        run: |
          python3 << 'PYEOF'
          import requests, os
          TOKEN = os.environ["GUMROAD_TOKEN"]
          H = {"Authorization": f"Bearer {TOKEN}"}
          
          PRODUCTS = [
            {"name": "The $0 AI Stack", "file": "01-the-zero-dollar-ai-stack.pdf", "desc": "Run real AI free forever. Ollama + Mistral + ChromaDB setup guide. 70% to PCRF."},
            {"name": "The Autonomous Email Responder", "file": "02-autonomous-email-responder.pdf", "desc": "Complete Python script + Gmail setup. AI answers emails in your voice. 70% to PCRF."},
            {"name": "The Grant Hunter System", "file": "03-grant-hunter-system.pdf", "desc": "Real grant sources, scripts, application automation. 70% to PCRF."},
            {"name": "The Viral Fork", "file": "04-the-viral-fork.pdf", "desc": "Build a self-replicating GitHub system. One click, anyone gets a copy. 70% to PCRF."},
            {"name": "Build a Store That Runs Itself", "file": "05-store-that-runs-itself.pdf", "desc": "Gumroad + GitHub Actions + email sequences. Zero maintenance store. 70% to PCRF."},
            {"name": "The Morning Briefing", "file": "06-the-morning-briefing.pdf", "desc": "Weather + news + AI thought emailed to you at 8am daily. 70% to PCRF."},
            {"name": "The Digital Twin", "file": "07-the-digital-twin.pdf", "desc": "Values file that gates every automated action your system takes. 70% to PCRF."},
            {"name": "Permanent Internet Presence", "file": "08-permanent-internet-presence.pdf", "desc": "Archive + IPFS + mirroring. Uncensorable. 70% to PCRF."},
            {"name": "The Prompt That Changed Everything", "file": "09-the-prompt-that-changed-everything.pdf", "desc": "Actual mechanics of prompt engineering. Not tricks, understanding. 70% to PCRF."},
            {"name": "The Ethical AI Business", "file": "10-the-ethical-ai-business.pdf", "desc": "Build AI products that make money and do good. The full framework. 70% to PCRF."},
          ]
          
          existing = {p["name"] for p in requests.get("https://api.gumroad.com/v2/products", headers=H).json().get("products", [])}
          
          for p in PRODUCTS:
            if p["name"] in existing:
              print(f"Exists: {p['name']}")
              continue
            pdf = f"products/pdf/{p['file']}"
            if not os.path.exists(pdf):
              print(f"No PDF: {p['file']}")
              continue
            r = requests.post("https://api.gumroad.com/v2/products", headers=H,
              data={"name": p["name"], "description": p["desc"], "price": 100, "published": True})
            if r.json().get("success"):
              pid = r.json()["product"]["id"]
              with open(pdf, "rb") as f:
                requests.post(f"https://api.gumroad.com/v2/products/{pid}/files", headers=H, files={"file": f})
              print(f"CREATED: {p['name']}")
          PYEOF
        env:
          GUMROAD_TOKEN: ${{ secrets.GUMROAD_TOKEN }}
