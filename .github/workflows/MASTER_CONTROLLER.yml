name: ðŸŒ¸ MASTER CONTROLLER â€” SolarPunk Autonomous Brain

# Runs every 30 min for health checks + retries
# Runs every 6 hours for full sequential cycle
# FIXED: unified_briefing.py replaces scattered per-engine emails
# FIXED: feedback-loop.yml, jekyll, email_gateway all patched this session

on:
  schedule:
    - cron: '*/30 * * * *'
    - cron: '0 */6 * * *'
  push:
    branches: [main]
    paths:
      - '.github/workflows/MASTER_CONTROLLER.yml'
      - 'mycelium/master_controller.py'
  workflow_dispatch:
    inputs:
      mode:
        description: 'health_check | full_cycle | retry_failures | emergency_fix'
        required: false
        default: 'health_check'

jobs:
  master_control:
    name: ðŸŒ¸ SolarPunk Master Controller
    runs-on: ubuntu-latest
    timeout-minutes: 55
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure git
        run: |
          git config user.name 'SolarPunk-MasterController'
          git config user.email 'solarpunk@meeko-nerve-center'
          mkdir -p data content public

      # â”€â”€ PHASE 1: Self-healing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 1 â€” Self-Healer (reads diagnostics, generates fixes)
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python mycelium/self_healer_v2.py
        continue-on-error: true

      # â”€â”€ PHASE 2: Workflow health + auto-retry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 2 â€” Workflow Health Monitor + Auto-Retry
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/master_controller.py
        continue-on-error: true

      # â”€â”€ PHASE 3: Core intelligence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 3a â€” World Intelligence
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python mycelium/world_intelligence.py
        continue-on-error: true

      - name: Phase 3b â€” Congress Watcher
        env:
          QUIVER_API_KEY: ${{ secrets.QUIVER_API_KEY }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: python mycelium/congress_watcher.py
        continue-on-error: true

      - name: Phase 3c â€” Crypto Signals
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: python mycelium/crypto_signal_engine.py
        continue-on-error: true

      # â”€â”€ PHASE 4: Investment intelligence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 4 â€” Investment Intelligence
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/investment_intelligence.py
        continue-on-error: true

      # â”€â”€ PHASE 5: Content + social â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 5a â€” Art Generation
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: python mycelium/art_cause_generator.py
        continue-on-error: true

      - name: Phase 5b â€” Social Posting
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
          MASTODON_BASE_URL: ${{ secrets.MASTODON_BASE_URL }}
          MASTODON_URL: ${{ secrets.MASTODON_URL }}
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: python mycelium/social_poster.py
        continue-on-error: true

      - name: Phase 5c â€” Press + News Monitor
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: python mycelium/news_monitor.py
        continue-on-error: true

      # â”€â”€ PHASE 6: Growth + network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 6a â€” Network Spreader
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
          MASTODON_BASE_URL: ${{ secrets.MASTODON_BASE_URL }}
          MASTODON_URL: ${{ secrets.MASTODON_URL }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/network_spreader.py
        continue-on-error: true

      - name: Phase 6b â€” Universal Spawner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ secrets.GITHUB_USERNAME }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/universal_spawner.py
        continue-on-error: true

      - name: Phase 6c â€” Email Gateway (humans only â€” GitHub noise blocked)
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python mycelium/email_gateway.py
        continue-on-error: true

      # â”€â”€ PHASE 7: Revenue + relationships â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 7a â€” Financial Loop Closer
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/financial_loop_closer.py
        continue-on-error: true

      - name: Phase 7b â€” Donor Lifecycle
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/donor_lifecycle.py
        continue-on-error: true

      - name: Phase 7c â€” Grant Intelligence (emails when new draft ready)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/grant_intelligence.py
        continue-on-error: true

      # â”€â”€ PHASE 8: Ethical pestering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 8 â€” Ethical Pesterer (corps + govs, never individuals)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
          MASTODON_BASE_URL: ${{ secrets.MASTODON_BASE_URL }}
          MASTODON_URL: ${{ secrets.MASTODON_URL }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/ethical_pesterer.py
        continue-on-error: true

      # â”€â”€ PHASE 9: Self-evolution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 9 â€” Perpetual Builder (build something new this cycle)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/perpetual_builder.py
        continue-on-error: true

      # â”€â”€ PHASE 10: Loops + dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 10a â€” Loop Closer (identifies open tasks)
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/loop_closer.py
        continue-on-error: true

      - name: Phase 10b â€” Dashboard Data Generator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: python mycelium/dashboard_data_generator.py
        continue-on-error: true

      # â”€â”€ PHASE 11: Sovereign research (weekly) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Phase 11 â€” Sovereign Entity Research
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: python mycelium/sovereign_research.py
        continue-on-error: true

      # â”€â”€ FINAL: ONE daily unified briefing email (delta-only, no duplicates) â”€â”€
      - name: Final 1 â€” Unified Briefing (ONE email/day with only NEW content)
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python mycelium/unified_briefing.py
        continue-on-error: true

      # â”€â”€ AUTONOMOUS GIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Final 2 â€” Autonomous Git (commit + push + resolve conflicts)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A
          git diff --cached --quiet && echo 'Nothing to commit' && exit 0
          FILE_COUNT=$(git diff --cached --name-only | wc -l | tr -d ' ')
          git commit -m "ðŸŒ¸ SolarPunk cycle [$(date +%Y-%m-%d\ %H:%M)] â€” ${FILE_COUNT} files"
          git pull --rebase origin main || git merge -X ours origin/main
          git push origin main || git push origin main --force-with-lease
        continue-on-error: true

      - name: Final 3 â€” Log completion
        run: echo "ðŸŒ¸ MASTER CONTROLLER COMPLETE â€” $(date)" >> data/master_controller_log.txt
        continue-on-error: true
