name: ðŸŒ± Fork Tracker

on:
  schedule:
    - cron: '30 6 * * *'   # daily 6:30 UTC
  workflow_dispatch:

jobs:
  track:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Fetch forks + update registry + RESULTS.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 - <<'PYEOF'
          import json, os, datetime, urllib.request, urllib.error

          token  = os.environ["GH_TOKEN"]
          owner  = "meekotharaccoon-cell"
          repo   = "meeko-nerve-center"
          api    = f"https://api.github.com/repos/{owner}/{repo}"
          hdrs   = {"Authorization": f"Bearer {token}",
                    "Accept": "application/vnd.github+json",
                    "X-GitHub-Api-Version": "2022-11-28"}

          def get(url):
              req = urllib.request.Request(url, headers=hdrs)
              with urllib.request.urlopen(req) as r:
                  return json.loads(r.read())

          # â”€â”€ Repo stats
          info   = get(api)
          forks  = info["forks_count"]
          stars  = info["stargazers_count"]
          watchers = info["watchers_count"]

          # â”€â”€ Fork list (up to 100)
          fork_data = get(api + "/forks?per_page=100&sort=newest")

          now = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

          # â”€â”€ Write FORK_REGISTRY.md
          lines = [
              "# ðŸŒ± Fork Registry â€” Meeko Mycelium",
              "",
              f"*Auto-updated: {now}*  ",
              f"**Total forks: {forks}** Â· Stars: {stars} Â· Watchers: {watchers}",
              "",
              "## Active Forks",
              "",
          ]

          if fork_data:
              lines.append("| Fork | Owner | Created | Stars |")
              lines.append("|------|-------|---------|-------|")
              for f in fork_data:
                  created = f["created_at"][:10]
                  fstars  = f["stargazers_count"]
                  lines.append(f"| [{f['full_name']}]({f['html_url']}) | {f['owner']['login']} | {created} | {fstars} |")
          else:
              lines.append("*No forks yet â€” be the first: https://github.com/meekotharaccoon-cell/meeko-nerve-center/fork*")
              lines.append("")
              lines.append("> Every fork is a new node in the network. Fork it, aim it at your cause, let it run.")

          lines += [
              "",
              "---",
              f"*Generated by fork-tracker.yml Â· {now}*"
          ]

          with open("FORK_REGISTRY.md", "w") as f:
              f.write("\n".join(lines) + "\n")

          # â”€â”€ Write / update RESULTS.md
          # Read existing if present
          try:
              with open("RESULTS.md") as f:
                  existing = f.read()
          except FileNotFoundError:
              existing = ""

          # Extract or initialise milestones block
          result_lines = [
              "# ðŸ“Š RESULTS â€” Meeko Mycelium",
              "",
              "> This file is auto-updated daily by fork-tracker.yml.",
              "> It is the live proof that the system is working.",
              "",
              "## Live Numbers",
              "",
              f"| Metric | Value | Updated |",
              f"|--------|-------|---------|" ,
              f"| GitHub Forks | {forks} | {now} |",
              f"| GitHub Stars | {stars} | {now} |",
              f"| Workflows Active | 23 | static |",
              f"| Repos Live | 10 | static |",
              f"| Artworks in Gallery | 56 | static |",
              "",
              "## Milestones",
              "",
          ]

          # Carry forward milestone entries from previous RESULTS.md
          if "## Milestones" in existing:
              milestone_block = existing.split("## Milestones")[1].strip()
              # Remove trailing auto-gen marker
              if "---" in milestone_block:
                  milestone_block = milestone_block.split("---")[0].strip()
              result_lines.append(milestone_block)
          else:
              result_lines += [
                  "*First milestone: first fork Â· first sale Â· first grant application sent*",
                  "",
                  "Add milestones manually here â€” the workflow preserves this section.",
              ]

          result_lines += [
              "",
              "---",
              f"*Auto-generated {now} by fork-tracker.yml*"
          ]

          with open("RESULTS.md", "w") as f:
              f.write("\n".join(result_lines) + "\n")

          print(f"Done. Forks: {forks}, Stars: {stars}")
          PYEOF

      - name: Commit
        run: |
          git config user.name  "meeko-system"
          git config user.email "system@meeko-nerve-center"
          git add FORK_REGISTRY.md RESULTS.md
          git diff --cached --quiet || git commit -m "chore: fork tracker update [$(date -u +%Y-%m-%d)]" && git push
